worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
	
	server {
		listen 80;
		server_name visualstreet.cn;
        # 添加这个 location 块（用于证书续期）
        location /.well-known/acme-challenge/ {
            root C:/nginx/html;
            try_files $uri =404;
        }
		location / {
			return 301 https://$host$request_uri;
    }
}

	
    # 443端口的server，处理前端页面
    server {
        listen       443 ssl;
        server_name  visualstreet.cn;

        ssl_certificate      C:/Certbot/live/visualstreet.cn/fullchain.pem;
        ssl_certificate_key  C:/Certbot/live/visualstreet.cn/privkey.pem;
        client_max_body_size 5M;  # 设置请求体大小限制为 5MB

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # devclient 配置
        location /devclient/ {
            alias C:/workspace/dev/client/;
            index  index.html;
            try_files $uri $uri/ /devclient/index.html;
        }

        # prodclient 配置
        location /prodclient/ {
            alias C:/workspace/prod/client/;
            index  index.html;
            try_files $uri $uri/ /prodclient/index.html;
        }
         # devtech 配置
        location /devtech/ {
            alias C:/workspace/dev/tech/;
            index  index.html;
            try_files $uri $uri/ /devtech/index.html;
        }
         # prodtech 配置
        location /prodtech/ {
            alias C:/workspace/prod/tech/;
            index  index.html;
            try_files $uri $uri/ /prodtech/index.html;
        }

         # cityclient 配置
        location /cityclient/ {
            alias C:/workspace/prod/cityclient/;
            index  index.html;
            try_files $uri $uri/ /cityclient/index.html;
        }
         # devservice 配置
        location /devservice/ {
            alias C:/workspace/dev/service/;
            index  index.html;
            try_files $uri $uri/ /devservice/index.html;
        }

        # prodservice 配置
        location /prodservice/ {
            alias C:/workspace/prod/service/;
            index  index.html;
            try_files $uri $uri/ /prodservice/index.html;
        }

        
        # apidev配置 - 代理到本地8001端口
        location /apidev/ {
            proxy_pass http://localhost:8001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # docs文档
        location /openapi.json/ {
            proxy_pass http://localhost:8001/openapi.json;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

         # api配置 - 代理到本地8000端口
        location /api/ {
            proxy_pass http://localhost:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 开启 gzip
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

        # 静态文件缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }

        # 通用安全headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";
    }

    #8000端口的server，处理后端API
    

    #HTTP 重定向 HTTPS
    server {
        listen       80;
        server_name  visualstreet.cn;

        #prodclean 配置
        location /prodclean/ {
            alias C:/workspace/clean/frontend/;
            index  index.html;
            try_files $uri $uri/ /prodclean/index.html;
        }
    }
}